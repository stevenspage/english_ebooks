<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Library</title>
  <link rel="icon" href="favicon.png" type="image/png" />
  <link rel="shortcut icon" href="favicon.png" type="image/png" />
  <link rel="apple-touch-icon" href="favicon.png" />
  <link rel="stylesheet" href="styles/main.css" />
  <!-- epub.js 用于封面解析（本地纯静态可用） -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
</head>
<body>
  <div class="hero">
    <div class="wrap">
      <div class="brand">
        <h1>My Library</h1>
        <div class="sub">快速搜索、排序、继续阅读</div>
      </div>
      <div class="actions">
        <span id="count" class="chip">…</span>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="toolbar">
      <a href="index.html" class="btn-view btn-home" title="返回首页">
        <span class="home-icon">🏠</span>
        <span class="home-text">首页</span>
      </a>
      
      <div class="search-container">
        <button id="search-btn" class="btn-view search-btn" title="搜索书籍 (按 / 或 F)">
          <span class="search-icon">🔍</span>
        </button>
        <input id="search" class="input search-input" placeholder="搜索书名… (按 ESC 关闭)" style="display:none;" />
      </div>
      <select id="sort" class="select">
        <option value="added-desc" selected>按添加时间 (新→旧)</option>
        <option value="added-asc">按添加时间 (旧→新)</option>
        <option value="name-asc">按名称 A→Z</option>
        <option value="name-desc">按名称 Z→A</option>
        <option value="recent">按最近阅读</option>
      </select>

      <button id="view-toggle" class="btn-view" title="切换视图">
        <span class="view-icon">⊞</span>
      </button>
    </div>

    <section>
      <div id="skeleton" class="skeleton-grid" aria-hidden="true"></div>
      <div id="book-grid" class="grid" style="display:none;"></div>
      <div id="empty" class="empty" style="display:none;">书库为空。将 .epub 放入 ebooks/ 并运行脚本同步。</div>
    </section>
  </div>

  <script>
    // 视图模式设置
    const viewModeKey = 'site:viewMode';

    // 视图模式
    let currentViewMode = localStorage.getItem(viewModeKey) || 'list';
    (function initViewToggle(){
      const viewToggle = document.getElementById('view-toggle');
      const viewIcon = viewToggle.querySelector('.view-icon');
      
      function updateViewIcon() {
        viewIcon.textContent = currentViewMode === 'list' ? '⊞' : '≡';
        viewToggle.title = currentViewMode === 'list' ? '切换到封面视图' : '切换到列表视图';
      }
      
      updateViewIcon();
      
      viewToggle.addEventListener('click', ()=>{
        currentViewMode = currentViewMode === 'list' ? 'cover' : 'list';
        localStorage.setItem(viewModeKey, currentViewMode);
        updateViewIcon();
        render();
      });
    })();

    // 由脚本自动维护，请勿手动修改
    const bookFiles = [
    "Trading in the Zone Master the Market with Confidence, Discipline, and a Winning Attitude (Mark Douglas).epub",
    "Who Is Government (Michael Lewis).epub",
    "The Man Who Solved the Market (Gregory Zuckerman).epub",
    "Thinking in Bets Making Smarter Decisions When You Dont Have All the Facts (Annie Duke).epub",
    "Guadalcanal 1942-43_ Japan's bid to knock out Henderson(Mark Stille).epub",
    "Project Hail Mary (Andy Weir) .epub",
    "My Friends (Hisham Matar).epub",
    "If You Tell (Olsen, Gregg) .epub",
    "Private Client Wills, Trusts and Estate Planning (Lesley King) .epub",
    "Best Loser Wins Why Normal Thinking Never Wins the Trading Game – written by a high-stake day trader (Tom Hougaard).epub",
    "A Man Called Ove (Fredrik Backman) .epub",
    "The Family Office A Comprehensive Guide for Advisers, Practitioners, and Students (William I. Woodson Edward V. Marshall).epub",
    "The Oligarchs Daughter (Joseph Finder).epub",
    "Dear John (Nicholas Sparks).epub",
    "Mr. Mercedes (Stephen King) .epub",
    "Me Before You A Novel (Moyes Jojo) .epub",
    "Klara and The Sun (Kazuo Ishiguro) .epub",
    "Green Mile (King Stephen) .epub",
    "What I Talk About When I Talk About Running(Haruki Murakami).epub",
    "The Longest Ride (Sparks Nicholas) .epub",
    "The Graveyard Book (Neil Gaiman) .epub",
    "The Sum of All Fears (Tom Clancy) .epub",
    "The Bridges of Madison County (Waller, Robert James) .epub",
    "中式英语之鉴-北京外国语大学硕士研究生考试指定参考用书(琼·平卡姆 Joan Pinkham).epub",
    "The Trading Game A Confession (Gary Stevenson) .epub",
    "The Psychology of Money (Morgan Housel) .epub",
    "The New Yorker Stories (Beattie Ann) .epub",
    "The Naked Face (Sidney Sheldon) .epub",
    "The Let Them Theory • A Life-Changing Tool That Millions of People Can’t Stop Talking About (Mel Robbins) .epub",
    "The Godfather (Mario Puzo) .epub",
    "Start With Why_ How Great Leaders Inspire Everyone to Take Action(Simon Sinek).epub",
    "Sincerely, Carter (Whitney G) .epub",
    "Shoe Dog A Memoir by the Creator of Nike (Knight, Phil) .epub",
    "Rich AF The Winning Money Mindset That Will Change Your Life (Vivian Tu) .epub",
    "Quit (Annie Duke) .epub",
    "Outlive - The Science and Art of Longevity (Peter Attia, MD) .epub",
    "How Not to Drown in a Glass of Water (Angie Cruz) .epub",
    "From the Ground Up_ A Journey to Reimagine the Promise of America(Howard Schultz).epub",
    "Extinct - A Compendium of Obsolete Objects (Barbara Penner, ‎Adrian Forty, ‎Olivia Horsfall Turne).epub",
    "Correct your English errors avoid 99 of the common mistakes made by learners of English(Collins, Timothy G).epub",
    "Contact (Carl Sagan) .epub",
    "Becoming Bulletproof Protect Yourself, Read People, Influence Situations, and Live Fearlessly (Evy Poumpouras) .epub",
    "Airport (Arthur Hailey) .epub",
    "A stranger in the mirror (Sheldon Sidney) .epub"
];

    // 文件信息（包含添加时间）- 由脚本自动维护
    const bookInfo = [
    {
        "filename": "Trading in the Zone Master the Market with Confidence, Discipline, and a Winning Attitude (Mark Douglas).epub",
        "addTime": 1755499094.7900705,
        "addTimeISO": "2025-08-18T06:38:14.000Z"
    },
    {
        "filename": "Who Is Government (Michael Lewis).epub",
        "addTime": 1755499094.7122295,
        "addTimeISO": "2025-08-18T06:38:14.000Z"
    },
    {
        "filename": "The Man Who Solved the Market (Gregory Zuckerman).epub",
        "addTime": 1755499094.6549354,
        "addTimeISO": "2025-08-18T06:38:14.000Z"
    },
    {
        "filename": "Thinking in Bets Making Smarter Decisions When You Dont Have All the Facts (Annie Duke).epub",
        "addTime": 1755499094.6178055,
        "addTimeISO": "2025-08-18T06:38:14.000Z"
    },
    {
        "filename": "Guadalcanal 1942-43_ Japan's bid to knock out Henderson(Mark Stille).epub",
        "addTime": 1755362569.386627,
        "addTimeISO": "2025-08-16T16:42:49.000Z"
    },
    {
        "filename": "Project Hail Mary (Andy Weir) .epub",
        "addTime": 1754925767.9342213,
        "addTimeISO": "2025-08-11T15:22:47.000Z"
    },
    {
        "filename": "My Friends (Hisham Matar).epub",
        "addTime": 1754925767.8166773,
        "addTimeISO": "2025-08-11T15:22:47.000Z"
    },
    {
        "filename": "If You Tell (Olsen, Gregg) .epub",
        "addTime": 1754925767.717015,
        "addTimeISO": "2025-08-11T15:22:47.000Z"
    },
    {
        "filename": "Private Client Wills, Trusts and Estate Planning (Lesley King) .epub",
        "addTime": 1754925683.666343,
        "addTimeISO": "2025-08-11T15:21:23.000Z"
    },
    {
        "filename": "Best Loser Wins Why Normal Thinking Never Wins the Trading Game – written by a high-stake day trader (Tom Hougaard).epub",
        "addTime": 1754925683.5698874,
        "addTimeISO": "2025-08-11T15:21:23.000Z"
    },
    {
        "filename": "A Man Called Ove (Fredrik Backman) .epub",
        "addTime": 1754925683.4730418,
        "addTimeISO": "2025-08-11T15:21:23.000Z"
    },
    {
        "filename": "The Family Office A Comprehensive Guide for Advisers, Practitioners, and Students (William I. Woodson Edward V. Marshall).epub",
        "addTime": 1754925683.3601832,
        "addTimeISO": "2025-08-11T15:21:23.000Z"
    },
    {
        "filename": "The Oligarchs Daughter (Joseph Finder).epub",
        "addTime": 1753885579.153789,
        "addTimeISO": "2025-07-30T14:26:19.000Z"
    },
    {
        "filename": "Dear John (Nicholas Sparks).epub",
        "addTime": 1753770469.9298403,
        "addTimeISO": "2025-07-29T06:27:49.000Z"
    },
    {
        "filename": "Mr. Mercedes (Stephen King) .epub",
        "addTime": 1753770160.3398476,
        "addTimeISO": "2025-07-29T06:22:40.000Z"
    },
    {
        "filename": "Me Before You A Novel (Moyes Jojo) .epub",
        "addTime": 1753770160.3358433,
        "addTimeISO": "2025-07-29T06:22:40.000Z"
    },
    {
        "filename": "Klara and The Sun (Kazuo Ishiguro) .epub",
        "addTime": 1753770160.3307076,
        "addTimeISO": "2025-07-29T06:22:40.000Z"
    },
    {
        "filename": "Green Mile (King Stephen) .epub",
        "addTime": 1753770160.3266912,
        "addTimeISO": "2025-07-29T06:22:40.000Z"
    },
    {
        "filename": "What I Talk About When I Talk About Running(Haruki Murakami).epub",
        "addTime": 1753764724.847636,
        "addTimeISO": "2025-07-29T04:52:04.000Z"
    },
    {
        "filename": "The Longest Ride (Sparks Nicholas) .epub",
        "addTime": 1753764724.7580812,
        "addTimeISO": "2025-07-29T04:52:04.000Z"
    },
    {
        "filename": "The Graveyard Book (Neil Gaiman) .epub",
        "addTime": 1753764644.9699097,
        "addTimeISO": "2025-07-29T04:50:44.000Z"
    },
    {
        "filename": "The Sum of All Fears (Tom Clancy) .epub",
        "addTime": 1753764644.6383195,
        "addTimeISO": "2025-07-29T04:50:44.000Z"
    },
    {
        "filename": "The Bridges of Madison County (Waller, Robert James) .epub",
        "addTime": 1753764644.4415977,
        "addTimeISO": "2025-07-29T04:50:44.000Z"
    },
    {
        "filename": "中式英语之鉴-北京外国语大学硕士研究生考试指定参考用书(琼·平卡姆 Joan Pinkham).epub",
        "addTime": 1753109504.9899473,
        "addTimeISO": "2025-07-21T14:51:44.000Z"
    },
    {
        "filename": "The Trading Game A Confession (Gary Stevenson) .epub",
        "addTime": 1753109504.9839501,
        "addTimeISO": "2025-07-21T14:51:44.000Z"
    },
    {
        "filename": "The Psychology of Money (Morgan Housel) .epub",
        "addTime": 1753109504.9783738,
        "addTimeISO": "2025-07-21T14:51:44.000Z"
    },
    {
        "filename": "The New Yorker Stories (Beattie Ann) .epub",
        "addTime": 1753109504.9743738,
        "addTimeISO": "2025-07-21T14:51:44.000Z"
    },
    {
        "filename": "The Naked Face (Sidney Sheldon) .epub",
        "addTime": 1753109504.9698706,
        "addTimeISO": "2025-07-21T14:51:44.000Z"
    },
    {
        "filename": "The Let Them Theory • A Life-Changing Tool That Millions of People Can’t Stop Talking About (Mel Robbins) .epub",
        "addTime": 1753109504.9631302,
        "addTimeISO": "2025-07-21T14:51:44.000Z"
    },
    {
        "filename": "The Godfather (Mario Puzo) .epub",
        "addTime": 1753109504.9601314,
        "addTimeISO": "2025-07-21T14:51:44.000Z"
    },
    {
        "filename": "Start With Why_ How Great Leaders Inspire Everyone to Take Action(Simon Sinek).epub",
        "addTime": 1753109504.9561257,
        "addTimeISO": "2025-07-21T14:51:44.000Z"
    },
    {
        "filename": "Sincerely, Carter (Whitney G) .epub",
        "addTime": 1753109504.952122,
        "addTimeISO": "2025-07-21T14:51:44.000Z"
    },
    {
        "filename": "Shoe Dog A Memoir by the Creator of Nike (Knight, Phil) .epub",
        "addTime": 1753109504.9474022,
        "addTimeISO": "2025-07-21T14:51:44.000Z"
    },
    {
        "filename": "Rich AF The Winning Money Mindset That Will Change Your Life (Vivian Tu) .epub",
        "addTime": 1753109504.941401,
        "addTimeISO": "2025-07-21T14:51:44.000Z"
    },
    {
        "filename": "Quit (Annie Duke) .epub",
        "addTime": 1753109504.9374018,
        "addTimeISO": "2025-07-21T14:51:44.000Z"
    },
    {
        "filename": "Outlive - The Science and Art of Longevity (Peter Attia, MD) .epub",
        "addTime": 1753109504.931405,
        "addTimeISO": "2025-07-21T14:51:44.000Z"
    },
    {
        "filename": "How Not to Drown in a Glass of Water (Angie Cruz) .epub",
        "addTime": 1753109504.9273992,
        "addTimeISO": "2025-07-21T14:51:44.000Z"
    },
    {
        "filename": "From the Ground Up_ A Journey to Reimagine the Promise of America(Howard Schultz).epub",
        "addTime": 1753109504.9224045,
        "addTimeISO": "2025-07-21T14:51:44.000Z"
    },
    {
        "filename": "Extinct - A Compendium of Obsolete Objects (Barbara Penner, ‎Adrian Forty, ‎Olivia Horsfall Turne).epub",
        "addTime": 1753109504.9149456,
        "addTimeISO": "2025-07-21T14:51:44.000Z"
    },
    {
        "filename": "Correct your English errors avoid 99 of the common mistakes made by learners of English(Collins, Timothy G).epub",
        "addTime": 1753109504.904951,
        "addTimeISO": "2025-07-21T14:51:44.000Z"
    },
    {
        "filename": "Contact (Carl Sagan) .epub",
        "addTime": 1753109504.9004714,
        "addTimeISO": "2025-07-21T14:51:44.000Z"
    },
    {
        "filename": "Becoming Bulletproof Protect Yourself, Read People, Influence Situations, and Live Fearlessly (Evy Poumpouras) .epub",
        "addTime": 1753109504.8914726,
        "addTimeISO": "2025-07-21T14:51:44.000Z"
    },
    {
        "filename": "Airport (Arthur Hailey) .epub",
        "addTime": 1753109504.8864708,
        "addTimeISO": "2025-07-21T14:51:44.000Z"
    },
    {
        "filename": "A stranger in the mirror (Sheldon Sidney) .epub",
        "addTime": 1753109504.8804698,
        "addTimeISO": "2025-07-21T14:51:44.000Z"
    }
];

    const basePath = "./ebooks/";
    // Service Worker 注册（需 http/https 环境，file:// 无效）
    if ('serviceWorker' in navigator && location.protocol !== 'file:') {
      navigator.serviceWorker.register('sw.js').catch(()=>{});
    }
    const gridEl = document.getElementById('book-grid');
    const skeletonEl = document.getElementById('skeleton');
    const emptyEl = document.getElementById('empty');
    const searchEl = document.getElementById('search');
    const sortEl = document.getElementById('sort');
    const countEl = document.getElementById('count');

    function fileNameToTitle(name) { return name ? name.replace(/\.epub$/i, '') : ''; }
    function getLastState(bookPath) {
      try { const raw = localStorage.getItem('reader:lastLocation:' + bookPath); return raw ? JSON.parse(raw) : null; } catch { return null; }
    }
    function fmtPercent(p) { if (p==null || isNaN(p)) return ''; const v = Math.max(0, Math.min(100, Math.round(p*100))); return v + '%'; }

    function renderSkeleton(count = 6) {
      skeletonEl.innerHTML = '';
      for (let i=0;i<count;i++) {
        const card = document.createElement('div'); card.className = 'skeleton-card';
        const row = document.createElement('div'); row.className = 'skeleton-row';
        const th = document.createElement('div'); th.className = 'sk-thumb';
        const box = document.createElement('div'); box.style.flex = '1';
        const l1 = document.createElement('div'); l1.className = 'sk-line w70';
        const l2 = document.createElement('div'); l2.className = 'sk-line w40';
        box.appendChild(l1); box.appendChild(l2);
        row.appendChild(th); row.appendChild(box);
        card.appendChild(row);
        skeletonEl.appendChild(card);
      }
      skeletonEl.style.display = '';
      gridEl.style.display = 'none';
    }

    function clearSkeleton() {
      skeletonEl.style.display = 'none';
      gridEl.style.display = '';
    }

    // 获取文件的添加时间
    function getFileAddTime(filename) {
      const fileInfo = bookInfo.find(info => info.filename === filename);
      return fileInfo ? (fileInfo.addTime || 0) : 0;
    }

    // 格式化文件添加时间为用户友好的文本
    function formatFileTime(filename) {
      const fileInfo = bookInfo.find(info => info.filename === filename);
      if (!fileInfo || !fileInfo.addTime) return '';
      
      const date = new Date(fileInfo.addTime * 1000);
      const now = new Date();
      const diffMs = now - date;
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      
      if (diffDays === 0) {
        return '今天';
      } else if (diffDays === 1) {
        return '昨天';
      } else if (diffDays < 7) {
        return `${diffDays}天前`;
      } else if (diffDays < 30) {
        return `${Math.floor(diffDays / 7)}周前`;
      } else if (diffDays < 365) {
        return `${Math.floor(diffDays / 30)}个月前`;
      } else {
        return date.toLocaleDateString('zh-CN');
      }
    }

    function render() {
      const q = (searchEl.value || '').toLowerCase().trim();
      let items = bookFiles.map((f, index) => ({ 
        title: fileNameToTitle(f), 
        file: f, 
        path: basePath + f,
        addedIndex: index, // 用于按添加时间排序（兼容模式）
        addTime: getFileAddTime(f) // 文件添加时间
      }));
      const total = items.length;
      if (q) items = items.filter(it => it.title.toLowerCase().includes(q));

      const sortBy = sortEl.value;
      if (sortBy === 'name-asc' || sortBy === 'name-desc') {
        items.sort((a,b) => a.title.localeCompare(b.title, 'zh-Hans-CN'));
        if (sortBy === 'name-desc') items.reverse();
      } else if (sortBy === 'recent') {
        items.sort((a,b) => (getLastState(b.path)?.updatedAt||0) - (getLastState(a.path)?.updatedAt||0));
      } else if (sortBy === 'added-desc') {
        // 按添加时间降序（使用文件创建时间）
        items.sort((a,b) => {
          if (bookInfo.length > 0 && a.addTime && b.addTime) {
            return b.addTime - a.addTime; // 按文件创建时间降序
          } else {
            return b.addedIndex - a.addedIndex; // 兼容模式：按添加索引降序
          }
        });
      } else if (sortBy === 'added-asc') {
        // 按添加时间升序（使用文件创建时间）
        items.sort((a,b) => {
          if (bookInfo.length > 0 && a.addTime && b.addTime) {
            return a.addTime - b.addTime; // 按文件创建时间升序
          } else {
            return a.addedIndex - b.addedIndex; // 兼容模式：按添加索引升序
          }
        });
      }

      gridEl.className = currentViewMode === 'cover' ? 'cover-grid' : 'grid';
      gridEl.innerHTML = '';
      emptyEl.style.display = items.length ? 'none' : 'block';
      countEl.textContent = `共 ${total} 本 · 显示 ${items.length} 本`;

      items.forEach(it => {
        const st = getLastState(it.path);
        const hasProgress = st && typeof st.percentage === 'number';
        
        if (currentViewMode === 'cover') {
          const card = document.createElement('div');
          card.className = 'cover-card';
          const link = document.createElement('a');
          link.href = `reader.html?book=${encodeURIComponent(it.path)}`;
          
          const coverImage = document.createElement('div');
          coverImage.className = 'cover-image';
          coverImage.innerHTML = '<div class="fallback">EP</div>';
          
          // 使用辅助函数创建下载UI
          const { container: downloadUI } = createDownloadUI();
          card.appendChild(downloadUI);
          
          // 使用辅助函数处理点击事件
          coverImage.addEventListener('click', (e) => handleCoverClick(e, it.path, card));
          
          const coverInfo = document.createElement('div');
          coverInfo.className = 'cover-info';
          
          const coverTitle = document.createElement('div');
          coverTitle.className = 'cover-title';
          coverTitle.textContent = it.title.slice(0, 32);
          
          const coverMeta = document.createElement('div');
          coverMeta.className = 'cover-meta';
          if (hasProgress) {
            const pill = document.createElement('span');
            pill.className = 'cover-pill';
            pill.textContent = fmtPercent(st.percentage);
            coverMeta.appendChild(pill);
          }
          
          const format = document.createElement('span');
          format.textContent = '📖 EPUB';
          coverMeta.appendChild(format);
          
          // 添加文件时间信息
          const fileTime = formatFileTime(it.file);
          if (fileTime && bookInfo.length > 0) {
            const timeSpan = document.createElement('span');
            timeSpan.className = 'file-time';
            timeSpan.textContent = `📅 ${fileTime}`;
            coverMeta.appendChild(timeSpan);
          }
          
          coverInfo.appendChild(coverTitle);
          coverInfo.appendChild(coverMeta);
          link.appendChild(coverImage);
          link.appendChild(coverInfo);
          card.appendChild(link);
          gridEl.appendChild(card);
          
          observeCover(it.path, coverImage);
        } else {
          // 列表视图
          const card = document.createElement('div');
          card.className = 'card';
          const linkWrap = document.createElement('a');
          linkWrap.href = `reader.html?book=${encodeURIComponent(it.path)}`;

          const wrap = document.createElement('div');
          wrap.className = 'row';

           const thumb = document.createElement('div'); 
           thumb.className = 'thumb'; 
           thumb.textContent = 'EP';
           
           // 使用辅助函数创建下载UI
           const { container: downloadUI } = createDownloadUI();
           card.appendChild(downloadUI);
           
           // 使用辅助函数处理点击事件
           thumb.addEventListener('click', (e) => handleCoverClick(e, it.path, card));

          const content = document.createElement('div'); content.style.flex = '1';
          const title = document.createElement('div'); title.className = 'title'; title.textContent = it.title;
          const meta = document.createElement('div'); meta.className = 'meta';
          if (hasProgress) {
            const pill = document.createElement('span'); pill.className = 'pill'; pill.textContent = '继续 ' + fmtPercent(st.percentage);
            meta.appendChild(pill);
          }
          
          const format = document.createElement('span');
          format.textContent = '📖 EPUB';
          meta.appendChild(format);
          
          // 添加文件时间信息
          const fileTime = formatFileTime(it.file);
          if (fileTime && bookInfo.length > 0) {
            const timeSpan = document.createElement('span');
            timeSpan.className = 'file-time';
            timeSpan.textContent = `📅 ${fileTime}`;
            meta.appendChild(timeSpan);
          }
          
          content.appendChild(title); content.appendChild(meta);
          wrap.appendChild(thumb); wrap.appendChild(content);
          linkWrap.appendChild(wrap);
          card.appendChild(linkWrap);
          gridEl.appendChild(card);
          
          observeCover(it.path, thumb);
        }
      });

      clearSkeleton();
      // 在渲染完成后，检查并更新已下载书籍的UI状态
      checkDownloadedBooks();
    }

    // 搜索框展开/收起逻辑
    (function initSearch() {
      const searchBtn = document.getElementById('search-btn');
      const searchInput = document.getElementById('search');
      const toolbar = document.querySelector('.toolbar');
      let isSearchOpen = false;

      function openSearch() {
        if (!isSearchOpen) {
          isSearchOpen = true;
          toolbar.classList.add('search-mode');
          searchInput.style.display = 'block';
          searchInput.focus();
          searchInput.select();
        }
      }

      function closeSearch() {
        if (isSearchOpen && !searchInput.value.trim()) {
          isSearchOpen = false;
          toolbar.classList.remove('search-mode');
          searchInput.style.display = 'none';
        }
      }

      searchBtn.addEventListener('click', (e) => {
        e.preventDefault();
        if (isSearchOpen) {
          searchInput.focus();
        } else {
          openSearch();
        }
      });

      searchInput.addEventListener('blur', () => {
        setTimeout(closeSearch, 100); // 延迟关闭，避免点击其他元素时立即关闭
      });

      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          searchInput.value = '';
          closeSearch();
          render(); // 清空搜索时重新渲染
        }
      });

      // 导出函数供外部使用
      window.openSearch = openSearch;
    })();

    // 快捷键聚焦搜索
    document.addEventListener('keydown', (e) => {
      if (e.key === '/' || e.key.toLowerCase() === 'f') {
        e.preventDefault();
        window.openSearch();
      }
    });

    // 懒加载封面
    const coverObserver = 'IntersectionObserver' in window ? new IntersectionObserver((entries)=>{
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const {path, el} = entry.target.__cover || {};
          if (path && el) loadCover(path, el);
          coverObserver.unobserve(entry.target);
        }
      });
    }, { rootMargin: '100px' }) : null;

    function observeCover(path, el){
      el.__cover = {path, el};
      if (coverObserver) coverObserver.observe(el); else loadCover(path, el);
    }

    // 封面缓存工具
    const CoverCache = {
      INDEX_KEY: 'cover:index:v1',
      DATA_PREFIX: 'cover:data:v1:',
      TTL_MS: 30 * 24 * 60 * 60 * 1000, // 30 天
      MAX_ENTRIES: 40,

      // 安全的localStorage操作
      store: {
        get(key) {
          try {
            return localStorage.getItem(key);
          } catch {
            return null;
          }
        },
        set(key, value) {
          try {
            localStorage.setItem(key, value);
            return true;
          } catch {
            return false;
          }
        },
        remove(key) {
          try {
            localStorage.removeItem(key);
            return true;
          } catch {
            return false;
          }
        }
      },

      // 获取封面数据key
      getKey(path) { 
        return this.DATA_PREFIX + path; 
      },

      // 获取索引数据
      getIndex() {
        const data = this.store.get(this.INDEX_KEY) || '{}';
        try {
          return JSON.parse(data);
        } catch {
          return {};
        }
      },

      // 更新索引数据
      setIndex(idx) {
        this.store.set(this.INDEX_KEY, JSON.stringify(idx));
      },

      // 获取缓存的封面
      get(path) {
        const idx = this.getIndex();
        const entry = idx[path];
        if (!entry) return null;

        if ((Date.now() - entry.ts) > this.TTL_MS) {
          this.remove(path);
          return null;
        }

        return this.store.get(this.getKey(path));
      },

      // 设置封面缓存
      set(path, dataUrl) {
        if (this.store.set(this.getKey(path), dataUrl)) {
          const idx = this.getIndex();
          idx[path] = { ts: Date.now() };
          this.setIndex(idx);
          this.trim();
          return true;
        }
        return false;
      },

      // 移除封面缓存
      remove(path) {
        if (this.store.remove(this.getKey(path))) {
          const idx = this.getIndex();
          delete idx[path];
          this.setIndex(idx);
          return true;
        }
        return false;
      },

      // 清理过期缓存
      trim() {
        const idx = this.getIndex();
        const entries = Object.entries(idx)
          .sort((a, b) => b[1].ts - a[1].ts);

        if (entries.length <= this.MAX_ENTRIES) return;

        entries
          .slice(this.MAX_ENTRIES)
          .forEach(([path]) => this.remove(path));
      }
    };

    // 替换原来的函数调用
    function getCachedCover(path) {
      return CoverCache.get(path);
    }

    function setCachedCover(path, dataUrl) {
      return CoverCache.set(path, dataUrl);
    }

    function removeCover(path) {
      return CoverCache.remove(path);
    }
    function blobToDataURL(blob){ return new Promise((res)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(blob); }); }

    async function loadCover(bookPath, el){
      const cached = getCachedCover(bookPath);
      if (cached) { 
        setCoverImage(el, cached);
        return; 
      }

      // 优先从 covers/ 文件夹加载
      const baseName = bookPath.substring(bookPath.lastIndexOf('/') + 1).replace(/\.epub$/i, '');
      const coverExtensions = ['.jpeg', '.jpg', '.png'];
      for (const ext of coverExtensions) {
        const coverUrl = `./covers/${baseName}${ext}`;
        try {
          const response = await fetch(coverUrl, { method: 'HEAD' });
          if (response.ok) {
            setCoverImage(el, coverUrl);
            // 将有效的URL存入缓存
            setCachedCover(bookPath, coverUrl);
            return;
          }
        } catch (e) {
          // 网络错误或 fetch 失败，继续尝试下一个
        }
      }

      // 如果 covers/ 中没有，则回退到从 epub 文件提取
      try {
        const book = ePub(bookPath);
        if (typeof book.coverUrl === 'function') {
          const url = await book.coverUrl();
          if (url) {
            setCoverImage(el, url);
            try{
              const meta = await book.loaded.metadata; const coverId = meta && (meta.cover || meta.cover_id || meta['cover-id']);
              if (coverId && book.archive && typeof book.archive.get === 'function') {
                const blob = await book.archive.get(coverId); if (blob) { const dataUrl = await blobToDataURL(blob); setCachedCover(bookPath, dataUrl); }
              }
            }catch{}
            return;
          }
        }
        const meta = await book.loaded.metadata;
        const coverId = meta && (meta.cover || meta.cover_id || meta['cover-id']);
        if (coverId && book && book.archive && typeof book.archive.get === 'function') {
          const blob = await book.archive.get(coverId);
          if (blob) {
            const dataUrl = await blobToDataURL(blob);
            setCoverImage(el, dataUrl);
            setCachedCover(bookPath, dataUrl);
            return;
          }
        }
      } catch(e) { /* 忽略，使用 EP 占位 */ }
    }

    function setCoverImage(el, imageUrl) {
      const isCoverImage = el.classList.contains('cover-image');
      
      if (isCoverImage) {
        const fallback = el.querySelector('.fallback');
        if (fallback) fallback.style.display = 'none';
        
        const img = el.querySelector('img') || document.createElement('img');
        img.src = imageUrl;
        img.alt = 'Book Cover';
        if (!el.contains(img)) el.appendChild(img);
      } else {
        el.classList.add('has-cover'); 
        el.style.backgroundImage = `url('${imageUrl}')`;
      }
    }

     // 下载功能
     function startDownload(card, bookPath) {
       const downloadProgress = card.querySelector('.download-progress');
       const downloadLabel = card.querySelector('.download-complete-label');
       const progressFill = downloadProgress.querySelector('.progress-fill');
       const progressText = downloadProgress.querySelector('.progress-text');
       
       downloadProgress.style.display = 'block';
       downloadLabel.style.display = 'none';
       
       let progress = 0;
       const interval = setInterval(() => {
         progress += Math.random() * 15 + 5;
         if (progress >= 100) {
           progress = 100;
           clearInterval(interval);
           
           progressText.textContent = '下载完成';
           progressFill.style.width = '100%';
           
           setTimeout(() => {
             downloadProgress.style.display = 'none';
             downloadLabel.style.display = 'block';
             
             const downloadKey = `download:${bookPath}`;
             localStorage.setItem(downloadKey, JSON.stringify({
               completed: true,
               completedAt: Date.now()
             }));
           }, 1000);
         } else {
           progressText.textContent = `下载中 ${Math.round(progress)}%`;
           progressFill.style.width = progress + '%';
         }
       }, 200 + Math.random() * 300);
     }
     
     // 检查已下载的书籍
     function checkDownloadedBooks() {
       document.querySelectorAll('.cover-card, .card').forEach(card => {
         const link = card.querySelector('a');
         if (!link?.href.includes('book=')) return;
         
         const bookPath = decodeURIComponent(link.href.split('book=')[1]);
         if (checkDownloadStatus(bookPath)) {
           const label = card.querySelector('.download-complete-label');
           if (label) label.style.display = 'block';
         }
       });
     }
     
     // UI 创建辅助函数
    function createDownloadUI() {
      const container = document.createElement('div');
      
      const progress = document.createElement('div');
      progress.className = 'download-progress';
      progress.style.display = 'none';
      progress.innerHTML = `
        <div class="progress-bar">
          <div class="progress-fill" style="width: 0%"></div>
        </div>
        <span class="progress-text">准备下载...</span>
      `;
      
      const label = document.createElement('div');
      label.className = 'download-complete-label';
      label.style.display = 'none';
      label.innerHTML = '✓ 已下载';
      
      container.appendChild(progress);
      container.appendChild(label);
      return { container, progress, label };
    }

    // 下载状态检查辅助函数
    function checkDownloadStatus(path) {
      const downloadKey = `download:${path}`;
      const downloadStatus = localStorage.getItem(downloadKey);
      let isDownloaded = false;
      try {
        if (downloadStatus) {
          isDownloaded = JSON.parse(downloadStatus).completed === true;
        }
      } catch (err) { /* 忽略损坏的数据 */ }
      return isDownloaded;
    }

    // 点击处理辅助函数
    function handleCoverClick(e, path, card) {
      if (checkDownloadStatus(path)) {
        return; // 已下载，允许正常跳转
      }
      e.preventDefault();
      e.stopPropagation();
      startDownload(card, path);
    }

    // 添加防抖函数
    function debounce(fn, delay) {
      let timer;
      return function (...args) {
        clearTimeout(timer);
        timer = setTimeout(() => fn.apply(this, args), delay);
      };
    }

    // 使用防抖处理搜索
    searchEl.addEventListener('input', debounce(render, 300));
    sortEl.addEventListener('change', render);
    renderSkeleton(6);
     
    // 初始渲染
    requestAnimationFrame(render);
  </script>
</body>
</html>
