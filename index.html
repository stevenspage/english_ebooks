<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>我的电子书书库</title>
  <style>
    :root {
      --primary: #6366f1; /* 现代靛蓝色 */
      --primary-2: #8b5cf6; /* 渐变紫色 */
      --accent: #06b6d4; /* 青色点缀 */
      --bg: #fafafa; /* 更纯净的浅灰背景 */
      --card: #ffffff;
      --text: #0f172a; /* 更深的文字色 */
      --text-secondary: #475569; /* 次要文字 */
      --muted: #64748b; /* 柔和灰色 */
      --border: #e2e8f0; /* 轻微蓝调边框 */
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --blur: saturate(180%) blur(20px);
      --gradient-primary: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #06b6d4 100%);
      --gradient-subtle: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 50%, rgba(6, 182, 212, 0.05) 100%);
    }
    body.dark {
      --bg: #0f172a; /* 深蓝灰背景 */
      --card: #1e293b; /* 卡片深色 */
      --text: #f1f5f9; /* 纯白文字 */
      --text-secondary: #cbd5e1; /* 次要文字 */
      --muted: #94a3b8; /* 明亮灰色 */
      --border: #334155; /* 深色边框 */
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
      --gradient-primary: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #0891b2 100%);
      --gradient-subtle: linear-gradient(135deg, rgba(79, 70, 229, 0.1) 0%, rgba(124, 58, 237, 0.1) 50%, rgba(8, 145, 178, 0.1) 100%);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      color: var(--text);
      background-size: 20px 20px, 100% 100%, 100% 100%;
      padding: 0 16px 24px;
      transition: all .3s ease;
      min-height: 100vh;
    }

    .container { max-width: 1120px; margin: 0 auto; }

    /* Hero */
    .hero {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      margin: 0 -16px;
      padding: 24px 16px 16px;
      background: var(--gradient-primary);
      border-bottom: 1px solid rgba(255,255,255,0.2);
      box-shadow: var(--shadow-lg);
      border-radius: 0 0 24px 24px;
    }
    .hero .wrap { max-width: 1120px; margin: 0 auto; display:flex; align-items:flex-end; justify-content: space-between; gap: 12px; }
    .brand { color: #fff; }
    .brand h1 { margin: 0; font-size: 1.75rem; font-weight: 700; letter-spacing: -0.025em; }
    .brand .sub { margin-top: 6px; font-size: 1rem; opacity: .85; font-weight: 400; }

    .actions { display:flex; gap: 10px; align-items:center; }
    .chip { 
      padding: 8px 14px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.3); 
      color:#fff; background: rgba(255,255,255,0.15); font-weight: 500; 
      backdrop-filter: blur(12px); font-size: 0.875rem;
    }
    .btn-icon {
      width: 44px; height: 44px; display:inline-flex; align-items:center; justify-content:center;
      border-radius: 12px; border: 1px solid rgba(255,255,255,0.3); color:#fff; 
      background: rgba(255,255,255,0.15); cursor: pointer; 
      transition: all .2s ease; backdrop-filter: blur(12px); font-size: 1.1rem;
    }
    .btn-icon:hover { transform: translateY(-2px); background: rgba(255,255,255,0.25); box-shadow: 0 8px 25px rgba(0,0,0,0.2); }

    /* Toolbar */
    .toolbar { display:flex; gap: 12px; flex-wrap: wrap; align-items:center; margin: 20px 0; }
    .input, .select {
      padding: 12px 16px; border: 1px solid var(--border); border-radius: 12px; background: var(--card);
      outline: none; min-width: 220px; color: var(--text); box-shadow: var(--shadow);
      transition: all .2s ease; font-size: 0.95rem; font-weight: 500;
    }
    .input:focus, .select:focus {
      border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    .btn-view {
      padding: 12px 16px; border: 1px solid var(--border); border-radius: 12px; background: var(--card);
      color: var(--text); cursor: pointer; box-shadow: var(--shadow); transition: all .2s ease;
      display: flex; align-items: center; justify-content: center; min-width: auto; font-weight: 500;
    }
    .btn-view:hover { 
      border-color: var(--primary); 
      box-shadow: var(--shadow-lg); 
      transform: translateY(-2px);
      background: rgba(99, 102, 241, 0.05);
    }
    .view-icon { font-size: 18px; }
    .input::placeholder { color: var(--muted); }
    .badge { color: var(--text-secondary); font-weight: 500; }

    /* Grid */
    .card { 
      background: var(--card); border: 1px solid var(--border); border-radius: 16px; 
      box-shadow: var(--shadow); overflow: hidden; transition: all .3s ease; 
    }
    .card:hover { 
      transform: translateY(-4px); border-color: var(--primary); 
      box-shadow: var(--shadow-lg); 
    }
    .card a { text-decoration: none; color: inherit; display: block; padding: 16px; }
    .row { display:flex; gap: 14px; align-items:center; }
    .thumb { 
      width: 48px; height: 48px; border-radius: 12px; 
      background: var(--gradient-primary); 
      display:flex; align-items:center; justify-content:center; 
      font-weight: 700; color: white; font-size: 0.85rem;
    }
    .title { font-weight: 600; line-height: 1.4; color: var(--text); font-size: 0.95rem; }
    .meta { margin-top: 8px; display:flex; gap: 8px; align-items:center; color: var(--text-secondary); font-size: 0.8rem; }
    .pill { 
      padding: 4px 10px; border-radius: 999px; 
      background: rgba(99, 102, 241, 0.1); color: var(--primary); 
      border: 1px solid rgba(99, 102, 241, 0.2); font-weight: 500;
    }

    .grid { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: 14px; }
    @media (max-width: 900px) { .grid { grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width: 620px) { 
      .grid { grid-template-columns: 1fr; }
      .input, .select { min-width: 160px; }
      .hero { position: static; border-bottom: none; border-radius: 0 0 20px 20px; }
    }

    /* Cover View (大封面视图) */
    .cover-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
    @media (max-width: 900px) { .cover-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 16px; } }
    @media (max-width: 620px) { 
      .cover-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 14px; }
      .cover-image { height: 220px; }
    }
    
    .cover-card { 
      background: var(--card); border: 1px solid var(--border); border-radius: 20px; 
      box-shadow: var(--shadow); overflow: hidden; transition: all .3s ease; position: relative;
      display: flex; flex-direction: column; height: 100%;
    }
    .cover-card:hover { 
      transform: translateY(-6px); 
      border-color: var(--primary); 
      box-shadow: var(--shadow-lg);
    }
    .cover-card a { text-decoration: none; color: inherit; display: flex; flex-direction: column; height: 100%; }
    
    .cover-image { 
      width: 100%; height: 280px; background: var(--gradient-primary); 
      display: flex; align-items: center; justify-content: center; font-weight: 700; 
      color: white; font-size: 24px; position: relative; overflow: hidden;
      border-radius: 16px 16px 0 0; flex-shrink: 0;
    }
    .cover-image img {
      width: 100%; height: 100%; object-fit: contain; object-position: center;
      border-radius: 8px 8px 0 0;
    }
    .cover-image .fallback { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 1; }
    
    .cover-info { padding: 16px 18px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
    .cover-title { font-weight: 600; line-height: 1.4; font-size: 0.95rem; margin-bottom: 8px; color: var(--text); }
    .cover-meta { display:flex; gap: 8px; align-items:center; color: var(--text-secondary); font-size: 0.8rem; flex-wrap: wrap; }
    .cover-pill { 
      padding: 4px 8px; border-radius: 999px; 
      background: rgba(99, 102, 241, 0.1); color: var(--primary); 
      border: 1px solid rgba(99, 102, 241, 0.2); font-size: 0.75rem; font-weight: 500;
    }

    .empty { color: var(--muted); padding: 12px; text-align:center; }

    /* Skeleton Shimmer */
    .skeleton-grid { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: 14px; }
    @media (max-width: 900px) { .skeleton-grid { grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width: 620px) { .skeleton-grid { grid-template-columns: 1fr; } }
    .skeleton-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; box-shadow: var(--shadow); padding: 14px; }
    .skeleton-row { display:flex; gap: 12px; align-items:center; }
    .sk-thumb { width:44px; height:44px; border-radius:12px; background: linear-gradient(90deg, #eee, #f5f5f5, #eee); background-size: 200% 100%; animation: shimmer 1.2s linear infinite; }
    .sk-line { height: 12px; border-radius: 8px; background: linear-gradient(90deg, #eee, #f5f5f5, #eee); background-size: 200% 100%; animation: shimmer 1.2s linear infinite; }
    .sk-line.w70 { width: 70%; }
    .sk-line.w40 { width: 40%; margin-top:8px; }
    @keyframes shimmer { 0%{background-position: 200% 0;} 100%{background-position: -200% 0;} }

    /* Cover thumbnails */
    .thumb.has-cover { color: transparent; background-size: contain; background-position: center; background-repeat: no-repeat; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.05); }

    /* 10套高端主题配色方案 */
    


    /* 2. 星云深空 */
    .theme-nebula {
      --primary: #8a2be2;
      --primary-2: #9932cc;
      --accent: #ff1493;
      --bg: #f5f3ff;
      --card: #fefefe;
      --gradient-primary: linear-gradient(135deg, #8a2be2 0%, #9932cc 50%, #ff1493 100%);
      --gradient-subtle: linear-gradient(135deg, rgba(138, 43, 226, 0.12) 0%, rgba(153, 50, 204, 0.12) 50%, rgba(255, 20, 147, 0.12) 100%);
    }
    .theme-nebula.dark {
      --bg: #1a0b2e;
      --card: #2d1b3d;
      --gradient-primary: linear-gradient(135deg, #4a148c 0%, #6a1b9a 50%, #c2185b 100%);
      --gradient-subtle: linear-gradient(135deg, rgba(74, 20, 140, 0.18) 0%, rgba(106, 27, 154, 0.18) 50%, rgba(194, 24, 91, 0.18) 100%);
    }

    /* 3. 深海秘境 */
    .theme-ocean {
      --primary: #006994;
      --primary-2: #0088cc;
      --accent: #20b2aa;
      --bg: #f0f9ff;
      --card: #ffffff;
      --gradient-primary: linear-gradient(135deg, #006994 0%, #0088cc 50%, #20b2aa 100%);
      --gradient-subtle: linear-gradient(135deg, rgba(0, 105, 148, 0.12) 0%, rgba(0, 136, 204, 0.12) 50%, rgba(32, 178, 170, 0.12) 100%);
    }
    .theme-ocean.dark {
      --bg: #001122;
      --card: #0a1929;
      --gradient-primary: linear-gradient(135deg, #01579b 0%, #0277bd 50%, #00695c 100%);
      --gradient-subtle: linear-gradient(135deg, rgba(1, 87, 155, 0.18) 0%, rgba(2, 119, 189, 0.18) 50%, rgba(0, 105, 92, 0.18) 100%);
    }

    /* 4. 翡翠森林 */
    .theme-forest {
      --primary: #228b22;
      --primary-2: #32cd32;
      --accent: #90ee90;
      --bg: #f0fff0;
      --card: #ffffff;
      --gradient-primary: linear-gradient(135deg, #228b22 0%, #32cd32 50%, #90ee90 100%);
      --gradient-subtle: linear-gradient(135deg, rgba(34, 139, 34, 0.12) 0%, rgba(50, 205, 50, 0.12) 50%, rgba(144, 238, 144, 0.12) 100%);
    }
    .theme-forest.dark {
      --bg: #0d1b0d;
      --card: #1a2e1a;
      --gradient-primary: linear-gradient(135deg, #1b5e20 0%, #2e7d32 50%, #388e3c 100%);
      --gradient-subtle: linear-gradient(135deg, rgba(27, 94, 32, 0.18) 0%, rgba(46, 125, 50, 0.18) 50%, rgba(56, 142, 60, 0.18) 100%);
    }

    /* 5. 黄昏晚霞 */
    .theme-sunset {
      --primary: #ff6347;
      --primary-2: #ff8c00;
      --accent: #ffd700;
      --bg: #fff8f0;
      --card: #ffffff;
      --gradient-primary: linear-gradient(135deg, #ff6347 0%, #ff8c00 50%, #ffd700 100%);
      --gradient-subtle: linear-gradient(135deg, rgba(255, 99, 71, 0.12) 0%, rgba(255, 140, 0, 0.12) 50%, rgba(255, 215, 0, 0.12) 100%);
    }
    .theme-sunset.dark {
      --bg: #1a0f08;
      --card: #2d1810;
      --gradient-primary: linear-gradient(135deg, #d84315 0%, #ef6c00 50%, #f57c00 100%);
      --gradient-subtle: linear-gradient(135deg, rgba(216, 67, 21, 0.18) 0%, rgba(239, 108, 0, 0.18) 50%, rgba(245, 124, 0, 0.18) 100%);
    }

    /* 6. 赤焰烈火 */
    .theme-crimson {
      --primary: #dc143c;
      --primary-2: #ff0000;
      --accent: #ff6b35;
      --bg: #fff5f5;
      --card: #ffffff;
      --gradient-primary: linear-gradient(135deg, #dc143c 0%, #ff0000 50%, #ff6b35 100%);
      --gradient-subtle: linear-gradient(135deg, rgba(220, 20, 60, 0.12) 0%, rgba(255, 0, 0, 0.12) 50%, rgba(255, 107, 53, 0.12) 100%);
    }
    .theme-crimson.dark {
      --bg: #1a0808;
      --card: #2d1010;
      --gradient-primary: linear-gradient(135deg, #b71c1c 0%, #c62828 50%, #d32f2f 100%);
      --gradient-subtle: linear-gradient(135deg, rgba(183, 28, 28, 0.18) 0%, rgba(198, 40, 40, 0.18) 50%, rgba(211, 47, 47, 0.18) 100%);
    }

    /* 7. 樱花飞舞 */
    .theme-sakura {
      --primary: #ffb7c5;
      --primary-2: #ffc0cb;
      --accent: #ff69b4;
      --bg: #fef7f7;
      --card: #ffffff;
      --gradient-primary: linear-gradient(135deg, #ffb7c5 0%, #ffc0cb 50%, #ff69b4 100%);
      --gradient-subtle: linear-gradient(135deg, rgba(255, 183, 197, 0.12) 0%, rgba(255, 192, 203, 0.12) 50%, rgba(255, 105, 180, 0.12) 100%);
    }
    .theme-sakura.dark {
      --bg: #1a0f13;
      --card: #2d1a20;
      --gradient-primary: linear-gradient(135deg, #ad1457 0%, #c2185b 50%, #e91e63 100%);
      --gradient-subtle: linear-gradient(135deg, rgba(173, 20, 87, 0.18) 0%, rgba(194, 24, 91, 0.18) 50%, rgba(233, 30, 99, 0.18) 100%);
    }

    /* 8. 铂金雅韵 */
    .theme-platinum {
      --primary: #8c9eff;
      --primary-2: #b39ddb;
      --accent: #e1bee7;
      --bg: #f8f9fa;
      --card: #ffffff;
      --gradient-primary: linear-gradient(135deg, #8c9eff 0%, #b39ddb 50%, #e1bee7 100%);
      --gradient-subtle: linear-gradient(135deg, rgba(140, 158, 255, 0.12) 0%, rgba(179, 157, 219, 0.12) 50%, rgba(225, 190, 231, 0.12) 100%);
    }
    .theme-platinum.dark {
      --bg: #121212;
      --card: #1e1e1e;
      --gradient-primary: linear-gradient(135deg, #3f51b5 0%, #673ab7 50%, #9c27b0 100%);
      --gradient-subtle: linear-gradient(135deg, rgba(63, 81, 181, 0.18) 0%, rgba(103, 58, 183, 0.18) 50%, rgba(156, 39, 176, 0.18) 100%);
    }

    /* 9. 紫水晶 */
    .theme-amethyst {
      --primary: #9c27b0;
      --primary-2: #ba68c8;
      --accent: #ce93d8;
      --bg: #fce4ec;
      --card: #ffffff;
      --gradient-primary: linear-gradient(135deg, #9c27b0 0%, #ba68c8 50%, #ce93d8 100%);
      --gradient-subtle: linear-gradient(135deg, rgba(156, 39, 176, 0.12) 0%, rgba(186, 104, 200, 0.12) 50%, rgba(206, 147, 216, 0.12) 100%);
    }
    .theme-amethyst.dark {
      --bg: #1a0f1a;
      --card: #2d1a2d;
      --gradient-primary: linear-gradient(135deg, #4a148c 0%, #6a1b9a 50%, #7b1fa2 100%);
      --gradient-subtle: linear-gradient(135deg, rgba(74, 20, 140, 0.18) 0%, rgba(106, 27, 154, 0.18) 50%, rgba(123, 31, 162, 0.18) 100%);
    }

    /* 10. 冰川蓝调 */
    .theme-glacier {
      --primary: #4fc3f7;
      --primary-2: #81d4fa;
      --accent: #b3e5fc;
      --bg: #e1f5fe;
      --card: #ffffff;
      --gradient-primary: linear-gradient(135deg, #4fc3f7 0%, #81d4fa 50%, #b3e5fc 100%);
      --gradient-subtle: linear-gradient(135deg, rgba(79, 195, 247, 0.12) 0%, rgba(129, 212, 250, 0.12) 50%, rgba(179, 229, 252, 0.12) 100%);
    }
    .theme-glacier.dark {
      --bg: #0f1419;
      --card: #1a252e;
      --gradient-primary: linear-gradient(135deg, #0277bd 0%, #0288d1 50%, #039be5 100%);
      --gradient-subtle: linear-gradient(135deg, rgba(2, 119, 189, 0.18) 0%, rgba(2, 136, 209, 0.18) 50%, rgba(3, 155, 229, 0.18) 100%);
    }

    /* 主题背景 - 强化色彩显示 */
    .theme-nebula { background: radial-gradient(circle at 30% 20%, rgba(138,43,226,0.2) 0%, transparent 50%), radial-gradient(circle at 70% 80%, rgba(255,20,147,0.2) 0%, transparent 50%), var(--gradient-subtle), var(--bg); }
    .theme-ocean { background: radial-gradient(circle at 25% 25%, rgba(0,105,148,0.2) 0%, transparent 50%), radial-gradient(circle at 75% 75%, rgba(32,178,170,0.2) 0%, transparent 50%), var(--gradient-subtle), var(--bg); }
    .theme-forest { background: radial-gradient(circle at 40% 30%, rgba(34,139,34,0.2) 0%, transparent 50%), radial-gradient(circle at 60% 70%, rgba(144,238,144,0.2) 0%, transparent 50%), var(--gradient-subtle), var(--bg); }
    .theme-sunset { background: radial-gradient(circle at 30% 40%, rgba(255,99,71,0.2) 0%, transparent 50%), radial-gradient(circle at 70% 60%, rgba(255,215,0,0.2) 0%, transparent 50%), var(--gradient-subtle), var(--bg); }
    .theme-crimson { background: radial-gradient(circle at 35% 35%, rgba(220,20,60,0.2) 0%, transparent 50%), radial-gradient(circle at 65% 65%, rgba(255,107,53,0.2) 0%, transparent 50%), var(--gradient-subtle), var(--bg); }
    .theme-sakura { background: radial-gradient(circle at 20% 40%, rgba(255,183,197,0.25) 0%, transparent 50%), radial-gradient(circle at 80% 60%, rgba(255,105,180,0.25) 0%, transparent 50%), var(--gradient-subtle), var(--bg); }
    .theme-platinum { background: radial-gradient(circle at 40% 20%, rgba(140,158,255,0.2) 0%, transparent 50%), radial-gradient(circle at 60% 80%, rgba(225,190,231,0.2) 0%, transparent 50%), var(--gradient-subtle), var(--bg); }
    .theme-amethyst { background: radial-gradient(circle at 25% 60%, rgba(156,39,176,0.2) 0%, transparent 50%), radial-gradient(circle at 75% 40%, rgba(206,147,216,0.2) 0%, transparent 50%), var(--gradient-subtle), var(--bg); }
    .theme-glacier { background: radial-gradient(circle at 30% 50%, rgba(79,195,247,0.25) 0%, transparent 50%), radial-gradient(circle at 70% 50%, rgba(179,229,252,0.25) 0%, transparent 50%), var(--gradient-subtle), var(--bg); }


  </style>
  <!-- epub.js 用于封面解析（本地纯静态可用） -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
</head>
<body>
  <div class="hero">
    <div class="wrap">
      <div class="brand">
        <h1>My Library</h1>
        <div class="sub">快速搜索、排序、继续阅读</div>
      </div>
      <div class="actions">
        <span id="count" class="chip">…</span>
        <button id="toggle-theme" class="btn-icon" title="切换主题">🌓</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="toolbar">
      <input id="search" class="input" placeholder="搜索书名… (按 / 或 F 聚焦)" />
      <select id="sort" class="select">
        <option value="name-asc">按名称 A→Z</option>
        <option value="name-desc">按名称 Z→A</option>
        <option value="recent">按最近阅读</option>
      </select>

      <select id="theme-selector" class="select">
        <option value="nebula">星云深空</option>
        <option value="ocean">深海秘境</option>
        <option value="forest">翡翠森林</option>
        <option value="sunset">黄昏晚霞</option>
        <option value="crimson">赤焰烈火</option>
        <option value="sakura">樱花飞舞</option>
        <option value="platinum">铂金雅韵</option>
        <option value="amethyst">紫水晶</option>
        <option value="glacier">冰川蓝调</option>
      </select>
      <button id="view-toggle" class="btn-view" title="切换视图">
        <span class="view-icon">⊞</span>
      </button>
    </div>

    <section>
      <div id="skeleton" class="skeleton-grid" aria-hidden="true"></div>
      <div id="book-grid" class="grid" style="display:none;"></div>
      <div id="empty" class="empty" style="display:none;">书库为空。将 .epub 放入 ebooks/ 并运行脚本同步。</div>
    </section>
  </div>

  <script>
    // 主题
    const siteThemeKey = 'site:theme';
    const colorThemeKey = 'site:colorTheme';
    const viewModeKey = 'site:viewMode';
    
    (function initTheme(){
      const saved = localStorage.getItem(siteThemeKey);
      if (saved) document.body.classList.toggle('dark', saved === 'dark');
      else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) document.body.classList.add('dark');
      document.getElementById('toggle-theme').addEventListener('click', ()=>{
        const dark = !document.body.classList.contains('dark');
        document.body.classList.toggle('dark', dark);
        localStorage.setItem(siteThemeKey, dark ? 'dark' : 'light');
      });
    })();

    // 颜色主题
    (function initColorTheme(){
      const themeSelector = document.getElementById('theme-selector');
      const saved = localStorage.getItem(colorThemeKey) || 'sunset';
      themeSelector.value = saved;
      
      // 移除所有主题类
      document.body.className = document.body.className.replace(/theme-\w+/g, '');
      // 添加当前主题类
      document.body.classList.add(`theme-${saved}`);
      
      themeSelector.addEventListener('change', ()=>{
        const theme = themeSelector.value;
        // 移除所有主题类
        document.body.className = document.body.className.replace(/theme-\w+/g, '');
        // 添加新主题类
        document.body.classList.add(`theme-${theme}`);
        localStorage.setItem(colorThemeKey, theme);
      });
    })();

    // 视图模式
    let currentViewMode = localStorage.getItem(viewModeKey) || 'list';
    (function initViewToggle(){
      const viewToggle = document.getElementById('view-toggle');
      const viewIcon = viewToggle.querySelector('.view-icon');
      
      function updateViewIcon() {
        viewIcon.textContent = currentViewMode === 'list' ? '⊞' : '≡';
        viewToggle.title = currentViewMode === 'list' ? '切换到封面视图' : '切换到列表视图';
      }
      
      updateViewIcon();
      
      viewToggle.addEventListener('click', ()=>{
        currentViewMode = currentViewMode === 'list' ? 'cover' : 'list';
        localStorage.setItem(viewModeKey, currentViewMode);
        updateViewIcon();
        render();
      });
    })();

    // 由脚本自动维护，请勿手动修改
    const bookFiles = [
    "A Man Called Ove (Fredrik Backman) .epub",
    "A stranger in the mirror (Sheldon Sidney) .epub",
    "Airport (Arthur Hailey) .epub",
    "Becoming Bulletproof Protect Yourself, Read People, Influence Situations, and Live Fearlessly (Evy Poumpouras) .epub",
    "Best Loser Wins Why Normal Thinking Never Wins the Trading Game – written by a high-stake day trader (Tom Hougaard) .epub",
    "Best Loser Wins Why Normal Thinking Never Wins the Trading Game – written by a high-stake day trader (Tom Hougaard).epub",
    "Contact (Carl Sagan) .epub",
    "Correct your English errors avoid 99 of the common mistakes made by learners of English by Collins, Timothy G.epub",
    "Dear John (Nicholas Sparks).epub",
    "Extinct - A Compendium of Obsolete Objects ( etc.).epub",
    "From the Ground Up_ A Journey to Reimagine the Promise of America - Howard Schultz.epub",
    "Green Mile (King Stephen) .epub",
    "How Not to Drown in a Glass of Water (Angie Cruz) .epub",
    "If You Tell (Olsen, Gregg) (Z-Library).epub",
    "Klara and The Sun (Kazuo Ishiguro) .epub",
    "Me Before You A Novel (Moyes Jojo) (Z-Library).epub",
    "Me Before You A Novel (Moyes Jojo) .epub",
    "Mr. Mercedes (Stephen King) .epub",
    "My Friends (Hisham Matar) (Z-Library).epub",
    "Outlive - The Science and Art of Longevity (Peter Attia, MD) .epub",
    "Private Client Wills, Trusts and Estate Planning (Lesley King) .epub",
    "Project Hail Mary (Andy Weir) .epub",
    "Quit (Annie Duke) .epub",
    "Rich AF The Winning Money Mindset That Will Change Your Life (Vivian Tu) .epub",
    "Shoe Dog A Memoir by the Creator of Nike (Knight, Phil) .epub",
    "Sincerely, Carter (Whitney G) .epub",
    "Start With Why_ How Great Leaders Inspire Everyone to Take Action_nodrm.epub",
    "The Bridges of Madison County (Waller, Robert James) .epub",
    "The Family Office A Comprehensive Guide for Advisers, Practitioners, and Students (William I. Woodson Edward V. Marshall).epub",
    "The Godfather (Mario Puzo) .epub",
    "The Graveyard Book (Neil Gaiman) .epub",
    "The Let Them Theory • A Life-Changing Tool That Millions of People Can’t Stop Talking About (Mel Robbins) .epub",
    "The Longest Ride (Sparks Nicholas) .epub",
    "The Naked Face (Sidney Sheldon) .epub",
    "The New Yorker Stories (Beattie Ann) .epub",
    "The Oligarchs Daughter (Joseph Finder).epub",
    "The Psychology of Money (Morgan Housel) .epub",
    "The Sum of All Fears (Tom Clancy) .epub",
    "The Trading Game A Confession (Gary Stevenson) .epub",
    "What I Talk About When I Talk About Running (Ha... .epub",
    "中式英语之鉴(北京外国语大学硕士研究生考试指定参考用书)(图文版).epub"
];

    const basePath = "./ebooks/";
    // Service Worker 注册（需 http/https 环境，file:// 无效）
    if ('serviceWorker' in navigator && location.protocol !== 'file:') {
      navigator.serviceWorker.register('sw.js').catch(()=>{});
    }
    const gridEl = document.getElementById('book-grid');
    const skeletonEl = document.getElementById('skeleton');
    const emptyEl = document.getElementById('empty');
    const searchEl = document.getElementById('search');
    const sortEl = document.getElementById('sort');
    const countEl = document.getElementById('count');

    function fileNameToTitle(name) { return name ? name.replace(/\.epub$/i, '') : ''; }
    function getLastState(bookPath) {
      try { const raw = localStorage.getItem('reader:lastLocation:' + bookPath); return raw ? JSON.parse(raw) : null; } catch { return null; }
    }
    function fmtPercent(p) { if (p==null || isNaN(p)) return ''; const v = Math.max(0, Math.min(100, Math.round(p*100))); return v + '%'; }

    function renderSkeleton(count = 6) {
      skeletonEl.innerHTML = '';
      for (let i=0;i<count;i++) {
        const card = document.createElement('div'); card.className = 'skeleton-card';
        const row = document.createElement('div'); row.className = 'skeleton-row';
        const th = document.createElement('div'); th.className = 'sk-thumb';
        const box = document.createElement('div'); box.style.flex = '1';
        const l1 = document.createElement('div'); l1.className = 'sk-line w70';
        const l2 = document.createElement('div'); l2.className = 'sk-line w40';
        box.appendChild(l1); box.appendChild(l2);
        row.appendChild(th); row.appendChild(box);
        card.appendChild(row);
        skeletonEl.appendChild(card);
      }
      skeletonEl.style.display = '';
      gridEl.style.display = 'none';
    }

    function clearSkeleton() {
      skeletonEl.style.display = 'none';
      gridEl.style.display = '';
    }

    function render() {
      const q = (searchEl.value || '').toLowerCase().trim();
      let items = bookFiles.map(f => ({ title: fileNameToTitle(f), file: f, path: basePath + f }));
      const total = items.length;
      if (q) items = items.filter(it => it.title.toLowerCase().includes(q));

      const sortBy = sortEl.value;
      if (sortBy === 'name-asc' || sortBy === 'name-desc') {
        items.sort((a,b) => a.title.localeCompare(b.title, 'zh-Hans-CN'));
        if (sortBy === 'name-desc') items.reverse();
      } else if (sortBy === 'recent') {
        items.sort((a,b) => (getLastState(b.path)?.updatedAt||0) - (getLastState(a.path)?.updatedAt||0));
      }

      // 根据视图模式设置网格样式
      gridEl.className = currentViewMode === 'cover' ? 'cover-grid' : 'grid';
      gridEl.innerHTML = '';
      emptyEl.style.display = items.length ? 'none' : 'block';
      countEl.textContent = `共 ${total} 本 · 显示 ${items.length} 本`;

      items.forEach(it => {
        const st = getLastState(it.path);
        const hasProgress = st && typeof st.percentage === 'number';
        
        if (currentViewMode === 'cover') {
          // 大封面视图
          const card = document.createElement('div');
          card.className = 'cover-card';
          const link = document.createElement('a');
          link.href = `reader.html?book=${encodeURIComponent(it.path)}`;
          
          const coverImage = document.createElement('div');
          coverImage.className = 'cover-image';
          coverImage.innerHTML = '<div class="fallback">EP</div>';
          
          const coverInfo = document.createElement('div');
          coverInfo.className = 'cover-info';
          
          const coverTitle = document.createElement('div');
          coverTitle.className = 'cover-title';
          coverTitle.textContent = it.title.slice(0, 32);
          
          const coverMeta = document.createElement('div');
          coverMeta.className = 'cover-meta';
          if (hasProgress) {
            const pill = document.createElement('span');
            pill.className = 'cover-pill';
            pill.textContent = fmtPercent(st.percentage);
            coverMeta.appendChild(pill);
          }
          const format = document.createElement('span');
          format.textContent = '📖 EPUB';
          coverMeta.appendChild(format);
          
          coverInfo.appendChild(coverTitle);
          coverInfo.appendChild(coverMeta);
          link.appendChild(coverImage);
          link.appendChild(coverInfo);
          card.appendChild(link);
          gridEl.appendChild(card);
          
          // 懒加载封面
          observeCover(it.path, coverImage);
        } else {
          // 列表视图
          const card = document.createElement('div');
          card.className = 'card';
          const wrap = document.createElement('div');
          wrap.className = 'row';
          const thumb = document.createElement('div'); thumb.className = 'thumb'; thumb.textContent = 'EP';
          const content = document.createElement('div'); content.style.flex = '1';
          const title = document.createElement('div'); title.className = 'title'; title.textContent = it.title;
          const meta = document.createElement('div'); meta.className = 'meta';
          if (hasProgress) {
            const pill = document.createElement('span'); pill.className = 'pill'; pill.textContent = '继续 ' + fmtPercent(st.percentage);
            meta.appendChild(pill);
          }
          const format = document.createElement('span');
          format.textContent = '📖 EPUB';
          meta.appendChild(format);
          
          content.appendChild(title); content.appendChild(meta);
          wrap.appendChild(thumb); wrap.appendChild(content);
          const linkWrap = document.createElement('a'); linkWrap.href = `reader.html?book=${encodeURIComponent(it.path)}`; linkWrap.appendChild(wrap);
          card.appendChild(linkWrap);
          gridEl.appendChild(card);
          // 懒加载封面
          observeCover(it.path, thumb);
        }
      });

      clearSkeleton();
    }

    // 快捷键聚焦搜索
    document.addEventListener('keydown', (e) => {
      if (e.key === '/' || e.key.toLowerCase() === 'f') {
        if (document.activeElement !== searchEl) { e.preventDefault(); searchEl.focus(); searchEl.select(); }
      }
    });

    // 懒加载封面
    const coverObserver = 'IntersectionObserver' in window ? new IntersectionObserver((entries)=>{
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const {path, el} = entry.target.__cover || {};
          if (path && el) loadCover(path, el);
          coverObserver.unobserve(entry.target);
        }
      });
    }, { rootMargin: '100px' }) : null;

    function observeCover(path, el){
      el.__cover = {path, el};
      if (coverObserver) coverObserver.observe(el); else loadCover(path, el);
    }

    // 封面缓存工具
    const COVER_INDEX_KEY = 'cover:index:v1';
    const COVER_DATA_PREFIX = 'cover:data:v1:';
    const COVER_TTL_MS = 30 * 24 * 60 * 60 * 1000; // 30 天

    function getNow(){ return Date.now(); }
    function getIndex(){ try{ return JSON.parse(localStorage.getItem(COVER_INDEX_KEY)||'{}'); }catch{ return {}; } }
    function setIndex(idx){ try{ localStorage.setItem(COVER_INDEX_KEY, JSON.stringify(idx)); }catch{} }
    function getCoverKey(path){ return COVER_DATA_PREFIX + path; }
    function getCachedCover(path){
      try{
        const idx = getIndex();
        const it = idx[path];
        if (!it) return null;
        if ((getNow() - it.ts) > COVER_TTL_MS) { removeCover(path); return null; }
        const data = localStorage.getItem(getCoverKey(path));
        return data || null;
      }catch{ return null; }
    }
    function setCachedCover(path, dataUrl){
      try{
        localStorage.setItem(getCoverKey(path), dataUrl);
        const idx = getIndex(); idx[path] = { ts: getNow() }; setIndex(idx);
        trimCoverCache(40);
      }catch{}
    }
    function removeCover(path){
      try{
        localStorage.removeItem(getCoverKey(path));
        const idx = getIndex(); delete idx[path]; setIndex(idx);
      }catch{}
    }
    function trimCoverCache(max){
      try{
        const idx = getIndex();
        const entries = Object.entries(idx).sort((a,b)=> b[1].ts - a[1].ts);
        if (entries.length <= max) return;
        for (let i=max;i<entries.length;i++) removeCover(entries[i][0]);
      }catch{}
    }
    function blobToDataURL(blob){ return new Promise((res)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(blob); }); }

    async function loadCover(bookPath, el){
      // 先读缓存
      const cached = getCachedCover(bookPath);
      if (cached) { 
        setCoverImage(el, cached);
        return; 
      }
      try {
        const book = ePub(bookPath);
        // 优先尝试官方 API
        if (typeof book.coverUrl === 'function') {
          const url = await book.coverUrl();
          if (url) {
            setCoverImage(el, url);
            // 尝试通过 archive 获取 blob 以便缓存
            try{
              const meta = await book.loaded.metadata; const coverId = meta && (meta.cover || meta.cover_id || meta['cover-id']);
              if (coverId && book.archive && typeof book.archive.get === 'function') {
                const blob = await book.archive.get(coverId); if (blob) { const dataUrl = await blobToDataURL(blob); setCachedCover(bookPath, dataUrl); }
              }
            }catch{}
            return;
          }
        }
        // 退化：从 metadata.cover 获取资源
        const meta = await book.loaded.metadata;
        const coverId = meta && (meta.cover || meta.cover_id || meta['cover-id']);
        if (coverId && book && book.archive && typeof book.archive.get === 'function') {
          const blob = await book.archive.get(coverId);
          if (blob) {
            const dataUrl = await blobToDataURL(blob);
            setCoverImage(el, dataUrl);
            setCachedCover(bookPath, dataUrl);
            return;
          }
        }
      } catch(e) { /* 忽略，使用 EP 占位 */ }
    }

    function setCoverImage(el, imageUrl) {
      if (el.classList.contains('cover-image')) {
        // 大封面视图：使用 img 标签
        const fallback = el.querySelector('.fallback');
        if (fallback) fallback.style.display = 'none';
        
        let img = el.querySelector('img');
        if (!img) {
          img = document.createElement('img');
          el.appendChild(img);
        }
        img.src = imageUrl;
        img.alt = 'Book Cover';
      } else {
        // 列表视图：使用背景图片
        el.classList.add('has-cover'); 
        el.style.backgroundImage = `url('${imageUrl}')`;
      }
    }

    searchEl.addEventListener('input', render);
    sortEl.addEventListener('change', render);
    renderSkeleton(6);
    // 小延迟后渲染（给 skeleton 一点展示时间）
    setTimeout(render, 0);
  </script>
</body>
</html>
